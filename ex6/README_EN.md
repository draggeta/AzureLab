# Dag 6 - VPN Gateway

* [VPN Gateway](#vpn-gateway)
* [On-prem firewall uitrollen](#on-prem-firewall-uitrollen)
* [VPN configureren in Azure](#vpn-configureren-in-azure)
* [(Optioneel) Client VPN](#optioneel-client-vpn)
* [(Optioneel) Traffic manager aanpassingen](#optioneel-traffic-manager-aanpassingen)
* [Overig](#overig)
* [Lab clean-up](#lab-clean-up)

As BY Health Insurances is growing fast, cloud costs are starting to rise. The company has a high constant load and the variance in load isn't a lot. This means that the flexibility of the cloud is outweighed by the costs being incurred by the steady state. For this reason, part of the workload will be migrated to an on-premises datacenter. This is not a full migration back to on-premises, but their hybrid cloud strategy. Part of the production workload, dev/test environments and scale out will still be performed in Azure.

BY's datacenters and offices are located in places with excellent internet connectivity. For this reason BY has chosen to forgo an [`ExpressRoute`](https://learn.microsoft.com/en-us/azure/expressroute/expressroute-introduction) in favor of a VPN solution for connectivity between Azure and on-prem. Sadly, the SD-WAN device cannot be used to terminate the site-to-site VPN on. BY wants to support client VPNs for developers and the SD-WAN appliance doesn't support client VPNs.

The easiest solution is to use a [`VPN Gateway`](https://learn.microsoft.com/en-us/azure/vpn-gateway/) (`VGW`).

![VPN gateway/virtual network gateway](./data/vpn_gateway.svg)

## VPN Gateway

### Deploying the VPN Gateway

> **NOTE:** The placement of a `VPN gateways` is important. It will determine how routes are propagated and which peering functionality can be used. For peerings, `route servers` and `VPN gateways` are treated similarly and have the same limitations. It isn't possible to peer networks and have `VPN gateways` in both networks and have the VNETs use each others `VPN gateways`. 
>
> Its also not possible to have a combination of `route servers` en `virtual network gateway` be usable between peered VNETs.

On-prem, BGP is used for dynamic routing and VXLAN. Networks can exists one moment and disappear minutes later. For this reason routes need to be updated dynamically between Azure and the datacenter. BGP will be used for this purpose.

If the `VPN gateway` isn't deployed yet, start the deployment and take a break as the gateway deployment [takes a long time](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#vpn).

1. The `VGW` can be deployed in the hub. The deployment is straightforward.
    * The subnet must have a specific name.
    * Gateway type: VPN
    * VPN type: the version that supports [BGP](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview#can-i-use-bgp-with-azure-policy-vpn-gateways).
    * SKU: the [cheapest](https://azure.microsoft.com/en-gb/pricing/details/vpn-gateway/#pricing) **NON AZ** version that supports [BGP](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview#is-bgp-supported-on-all-azure-vpn-gateway-skus).
        * You may want to have zone redundancy in a real production environment
    * Enable active-active mode: Enabled
    * Configure BGP: Enabled
        * ASN: 65515
        * Custom Azure APIPA BGP IP address:
            * None, we'll be using the default tunnel addresses generated by Azure for the active/active virtual network gateway.
            * It's possible to use APIPA addresses instead of routed address. This may save time and effort if finding available prefixes is a difficult task.

    > <details><summary>Route servers and virtual network gateways</summary>
    >
    > When a route server and network gateway are used in combination with BGP, the network gateway has to be deployed in active/active mode. I do not know the reason for this. Maybe it has to do with Azure requiring redundancy. 
    >
    > The ASN of the `VNGs` is allowed to be the same as the `route server's`. Depending on the configuration, the peering between the `VNGs` and `route servers` can be EBGP or IBGP. This can influence routing.

    </details>

## On-prem firewall deployment

The following segment is purely to build an 'on-prem' datacenter in Azure. For the purposes of the labs, the on-prem environment is a black box. What you have to do as engineer is configure a site-to-site VPN connection between the Azure networks and the datacenter managed by the NOC.

### On-prem VNET deployment

1. Deploy a `VNET` in Azure. The used address-space doesn't matter. The to be deployed Linux firewall will simulate some subnets.
1. Create a subnet for the Linux firewall
1. Create an `NSG`:
    * Allow IKE/IPSec in- and outbound.
    * Allow SSH from your own public IP. 
    * Allow HTTP for the API service from everywhere.
    * BGP doesn't need to be allowed in the NSG. BGP traffic traverses over the tunnel.

### On-prem firewall deployment

Wait until the `VGW` is deployed en retrieve the public IP addresses.

1. Deploy an Ubuntu 22.04 VM as the firewall.
    * Use sensible sizes and settings
    * Assign the VM a public IP
    * Enter the contents of the [cloud-init](./tf/data/cloud-init.vpn.yml.j2) file in **CUSTOM DATA**, not **USER DATA**.
      
      > **NOTE:** change the `${vgw_peer_1}` and `${vgw_peer_2}` variabeles to the `VGW` public IPs.
      > 
      > Change the `${vgw_bgp_peer_1}` and `${vgw_bgp_peer_2}` variabeles to the `(Secondary) Default Azure BGP peer IP addresses` under the `virtual network gateway` > `Configuration` section.

We've just built a 'datacenter' and 'firewall' to be used as remote network. Try to log in to the 'firewall' to make sure you have connectivity.

## VPN configuration in Azure

A VPN connection in Azure consists of three resources:
1. `VPN gateway`, the VPN device/concentrator.
2. `Local network gateway`, information about the remote device (as seen from the perspective of the `VPN gateway`).
3. `Connection`, attaches a `VPN gateway` to a `local network gateway` and specifies the connection parameters.

### Local network gateway

The on-prem firewall has to be defined as an `LNG`. Create it.
* Endpoint: Both options are possible. Choose which you find easier.
* Address Spaces: Keep these fields empty. BGP is used, so 'static routes' don't need to be added.
    * If you won't be using BGP, all networks to begind the `LNG` need to be specified here.
* Enable BGP under the advanced tab.

The datacenter NOC has provided the following BGP connections settings.
* ASN: 65003
* BGP peer address: 10.64.255.255

Which details must be provided to the NOC?

> <details><summary>VPN gateway BGP config</summary>
>
> These details can be found under `virtual network gateway` > Configuration'.
</details>

### Connection

It's time to exchange VPN configurationinformation with the DC NOC. The following information has been received from the NOC:
* PSK: `DitIsEENV4ilugP0sSwerd`
* Phase 1:
    * Encryption: GCMAES128
    * Integrity: SHA256
    * DH Group: DH20 (ECP384)
* Phase 2:
    * Encryption: GCMAES128
    * Integrity: GCMAES128
    * DH Group: DH20 (ECP384)
* IPsec SA lifetime KB: 102400000
* IPsec SA lifetime s: 3600

Create a `connection` and with the above configuration. Also configure the following settings:
* Connection type: Site-to-site (IPsec)
* Enable BGP: check

### Troubleshooten VPN verbinding

It seems that there is something wrong with the VPN connection. It fails to connect as can be seen under the `connection` > `Overview`. Use the `VPN troubleshoot` option to troubleshoot the VPN. Send the output to the log/`network watcher` `storage account`. The troubleshooting step can take up to five minutes.

Wait until a status is returned under the `Troubleshooting status` column. Select the `connection` and not the gateway and open under `Details` the `Action` tab. 

Wacht totdat je een status terug krijgt onder kolom `Troubleshooting status`. Selecteer de `connection` en niet de gateway en controleer onder `Details` het `Action` tabblad.

> <details><summary>Cause and solution</summary>
> <img src="./data/connection_action.png" alt="Connection Action">
>
> It seems that there is a PSK mismatch. After some pushing, the NOC admits that they forgot to copy the last character of the string. The correct PSK is `DitIsEENV4ilugP0sSwerd!`.
> 
> Replace the PSK in the `connection`.
>
> The zip file written to the `storage account` contains detailed logs returned by the gateway. These can be viewed if needed. More troubleshooting information can be found in the [Microsoft documentation](https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway?WT.mc_id=Portal-Microsoft_Azure_HybridNetworking).

</details>

Verify that the connection is/will become active. This can be done on the `connection` resource, but also on the 'on-prem firewall':
```bash
sudo swanctl --list-sas
```

<!---
```
azure_primary: IKEv2, no reauthentication, rekeying every 14400s, dpd delay 30s
  local:  10.10.0.4
  remote: 20.8.124.18
  local pre-shared key authentication:
  remote pre-shared key authentication:
  route_vpn_primary: TUNNEL, rekeying every 3600s or 1024000000 bytes, dpd action is clear
    local:  0.0.0.0/0
    remote: 0.0.0.0/0
azure_secondary: IKEv2, no reauthentication, rekeying every 14400s, dpd delay 30s
  local:  10.10.0.4
  remote: 20.8.124.107
  local pre-shared key authentication:
  remote pre-shared key authentication:
  route_vpn_secondary: TUNNEL, rekeying every 3600s or 1024000000 bytes, dpd action is clear
    local:  0.0.0.0/0
    remote: 0.0.0.0/0
```
-->

### Verify BGP sessions and routes

The BGP sessions'll have become active if everything went well and routes should be exchanged too. On the 'on-prem firewall' open the vtysh with `sudo vtysh` to manage the FRR daemon and type the below commands.

```cisco
show bgp summary
show ip route 
```

It's also possible to view the peerings and learned routes via the `virtual network gateway` > `BGP peers` option.
Another option is to use the `effective routes` option of a VM.

What do you notice if you look at the routes output of the 'on-prem firewall', gateway and `effective routes`?

> <details><summary>Route servers and gateways</summary>
> <code>Route servers</code> don't automatically exchange routes with <code>virtual network gateways</code>, not even <code>ExpressRoute gateways</code>. This means that thr route server won't learn/advertise <code>VNG</code> learned routes and vice versa. In case this is desired, turn on <code>Branch-to-branch</code> under the <code>route server</code> > <code>Configuration</code>.
>
> After turning on the options, the routes should be learned on the SD-WAN, gateway and 'on-prem firewall'.

</details>

## (Optional) Client VPN

> **NOTE:** In case you don't have 'global admin' access to a (free) Azure AD tenant (or are a user in one where users are allowed to register Azure AD applications), the exercise will be theoretical. 

BY developers working from home want a solution to connect to the development environment. BY wants to use the `point-to-site` functionality of the `VGW`. BY has the following requirements for the type of `P2S` to use:
* It has to use TCP/443 to have the best possibility of working from various networks.
* It has to use Azure AD authentication as that is all the organization has for identity.
* It has to support Windows, MacOS and Ubuntu/Fedora clients.

Which [client/point-to-site VPN](https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about#protocol) passes all the requirements?

### Configureren client VPN

1. Go to the `VPN gateway` and open the `Point-to-site configuration`. Configure the client VPN as follows:
    * Address pool: 10.96.0.0/24
    * Tunnel type: OpenVPN (SSL)
    * Authentication type: Azure Active Directory
    * Public IP address: As we're running active/active, a third, load balanced client VPN IP address is needed. Create a new one or use an existing. **DO NOT** use the `Public IP` of the `NAT gateway`
2. Configure the Azure Active Directory settings. Make sure to use the tenant identifier and not the tenant domain name:
    * Tenant: [https://login.microsoftonline.com/{tenantId}/](https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-tenant#enable-authentication)
    * Audience: [41b23e61-6c1e-4545-b367-cd054e0ed4b4](https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-tenant#enable-authentication)
    * Issuer: [https://sts.windows.net/{tenantId}/](https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-tenant#enable-authentication)
    > <details><summary>Get tenant id</summary>
    > Use the following commands via the [cloud shell](https://shell.azure.com/) to get the tenant id:
    > <ul>
    > <li>powershell: <code>Get-AzTenant</code></li>
    > <li>bash: <code>az account list</code></li>
    > </ul>

    </details>

3. An Azure AD administrator account can be used to grant your tenant access to the `VGW` authentication app. Click on `Grant administrator consent for Azure VPN client application` or perform the steps as described in the [documentation](https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-tenant#authorize-the-application) beschreven.
    * Make sure to check the 'Consent on behalf of your organization' box. The accepts the authentication for all of the organization.
    ![Azure AD authentication](./data/client_vpn.png)
4. Click 'Save'. The deployment can take around 10 minutes. After the update has completed, download the VPN client configuration. Extract the ZIP files.

### Log in to the client VPN

Install the 'Azure VPN Client' as described in the [manual](https://learn.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-client). After the installation, import the azurevpnconfig.xml.

Connect to the VPN. Which routes do you see?

### Deploy another peered network

Deploy a new `VNET` for spoke C with the `10.131.0.0/16` address space. Peer it to the hub (allow gateway usage). Reconnect to the VPN. Which routes do you see?

> <details><summary>Point-to-site VPN and routes</summary>
> Point-to-site VPNs know all routes that are the VNET knows about. This means peered networks and what is learned from <code>route servers</code> and <code>virtual network gateways</code> (only if running BGP over the VPN).
>
> When it comes to IKEv2 VPN types, it becomes a bit more difficult. Windows clients won't learn any BGP routes by default. This means these routes need to be added as custom routes. Also, Windows clients won't learn about updates to the network as well. To apply the updates, the client must be <a href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-point-to-site-routing">redownloaded and installed</a>.

</details>

## (Optioneel) Traffic manager changes

By wants 50% of all (global) clients to connect to the datacenter. The rest should go to Azure in West Europe. 
## Lab clean-up

If you're not continuing to the next exercises, it's easier and cheaper to delete the lab when done. The end state of this lab can be [redeployed](../README_EN.md#lab-checkpoints) via the included [Terraform files](./tf/)
